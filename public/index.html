<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIS | Secure Portal</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0061f2">
    
    <link rel="apple-touch-icon" href="icon1.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ADIS">

    <link rel="stylesheet" href="https://cdn.rawgit.com/Chalarangelo/mini.css/v3.0.1/dist/mini-default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --primary-blue: #0061f2; 
            --dark-blue: #0e1c36; 
            --light-bg: #f8f9fc; 
            --success-green: #28a745; 
            --danger-red: #dc3545; 
            --card-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* Added touch-action for better mobile scrolling */
        body { background-color: var(--light-bg); font-family: 'Inter', system-ui, sans-serif; overflow-x: hidden; touch-action: pan-y; }

        /* --- ADD THIS TO YOUR CSS --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #0e1c36; /* Match your app theme */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease-out;
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid #0061f2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Page Styling */
        #login-page { height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at top right, #1a2a3a, #0e1c36); padding: 20px; }
        .login-card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); width: 100%; max-width: 450px; }
        .school-title { font-size: 1.1rem; font-weight: 800; color: var(--dark-blue); margin: 15px 0; line-height: 1.4; text-transform: uppercase; }
        
        /* App Layout */
        #main-app { display: none; }
        .top-bar { background: white; padding: 15px 20px; border-bottom: 1px solid #e3e6f0; position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; justify-content: space-between; }
        
        /* Sidebar Styling - Updated Transition and Z-Index */
        .sidebar { 
            position: fixed; 
            left: -320px; 
            top: 0; 
            height: 100vh; 
            width: 280px; 
            background: white; 
            color: var(--dark-blue); 
            /* Smoother transition */
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 2000; 
            padding: 20px; 
            overflow-y: auto; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.1); 
        }
        .sidebar.active { left: 0; }
        
        /* Overlay - Updated Z-Index */
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); z-index: 1500; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }
        
        /* Profile Section in Sidebar */
        .profile-section { background: var(--light-bg); padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; border: 1px solid #eee; }
        .profile-img-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        .profile-img { width: 100%; height: 100%; background: white; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:2rem; color:var(--primary-blue); border: 2px solid #e3e6f0; object-fit: cover; overflow: hidden; }
        .edit-icon { position: absolute; bottom: 0; right: 0; background: var(--primary-blue); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; cursor: pointer; border: 2px solid white; }
        .editable-field { display: flex; align-items: center; justify-content: center; gap: 8px; }
        .edit-btn { cursor: pointer; color: var(--primary-blue); font-size: 0.9rem; }
        .profile-details { margin-top: 15px; border-top: 1px solid #e3e6f0; padding-top: 15px; text-align: left; }

        /* Navigation Links (Sidebar) */
        .nav-link { color: #555; cursor: pointer; margin-bottom: 5px; padding: 12px 15px; border-radius: 12px; text-decoration: none; display: flex; align-items: center; transition: 0.2s; font-weight: 500;}
        .nav-link:hover { background: #f0f4ff; color: var(--primary-blue); }
        
        /* Content Area */
        .content-area { max-width: 800px; margin: 20px auto; padding: 0 15px; padding-bottom: 100px; }
        .section-panel { display: none; animation: slideUp 0.3s ease-out; }
        .active-panel { display: block; }
        .card { border: none; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 15px; background: white; padding: 20px; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Bottom Navigation Bar */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e3e6f0; z-index: 999; padding-bottom: 5px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { text-align: center; color: #6c757d; cursor: pointer; font-size: 0.75rem; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--primary-blue); font-weight: 600; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; display: block; }
        
        /* Icon Styling */
        .menu-icon { transition: transform 0.3s ease; display: inline-block; cursor: pointer; color: var(--dark-blue); }
        
        /* Utility */
        .role-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 10px; background: rgba(0,0,0,0.05); color: var(--primary-blue); font-weight: bold;}
    </style>
</head>
<body>
<div id="splash-screen">
    <div class="loader"></div>
    <h3>ADIS Portal</h3>
    <p>Loading application...</p>
</div>

<div id="login-page">
    <div class="login-card text-center">
        <img src="https://img.icons8.com/fluency/96/graduation-cap.png" width="70">
        <div class="school-title">ASHWAMEDH DREAM INTERNATIONAL SCHOOL</div>
        <input type="text" id="username" class="form-control mb-3" placeholder="User ID">
        <input type="password" id="password" class="form-control mb-4" placeholder="Password">
        <button class="btn btn-primary w-100 py-3 fw-bold" id="loginBtn" onclick="handleLogin()">LOGIN</button>
        <p id="login-error" class="text-danger mt-3 small"></p>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div class="top-bar shadow-sm">
        <div onclick="toggleSidebar()" style="padding: 5px;">
            <i class="fas fa-bars fs-4 menu-icon" id="menuIcon"></i>
        </div>
        <h6 class="mb-0 fw-bold" id="header-title">Home</h6>
        <i class="fas fa-search fs-5 text-muted" style="cursor:pointer;"></i>
    </div>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
    <div class="profile-section" id="profileToggle">
    <div class="profile-img-container">
        <div class="profile-img" id="user-avatar">
            <i class="fas fa-user"></i>
        </div>
        <label for="photo-upload" class="edit-icon">
            <i class="fas fa-camera"></i>
            <input type="file" id="photo-upload" accept="image/*" style="display:none;" onchange="updateProfilePhoto(this)">
        </label>
    </div>
    
    <div class="editable-field">
        <h5 class="fw-bold mb-1" id="user-display-name"></h5>
        <i class="fas fa-edit edit-btn" onclick="editName()"></i>
    </div>
    
    <span class="role-badge" id="user-display-role"></span>
    
    <div class="profile-details" id="profileDetails">
        <p class="small mb-1"><strong>Class:</strong> <span id="user-display-class">N/A</span></p>
        <p class="small mb-1"><strong>ID:</strong> <span id="user-display-id">N/A</span></p>
    </div>
    
    </div>
        
        <div id="nav-menu">
    <div class="nav-link" onclick="showSection('announcements', 'Home')">
        <i class="fas fa-home me-3"></i> Home
    </div>                
    
    <div class="nav-link" data-role="admin,teacher" style="display:none;" onclick="showSection('student-directory', 'Student Directory')">
        <i class="fas fa-address-book me-3"></i> Student Directory
    </div>

    <div class="nav-link" data-role="admin" style="display:none;" onclick="showSection('admin-teachers', 'Admin Panel')">
        <i class="fas fa-chalkboard-teacher me-3"></i> Admin Panel
    </div>                

    <div class="nav-link" data-role="admin,teacher" style="display:none;" onclick="showSection('staff-students', 'Manage Students')">
        <i class="fas fa-user-graduate me-3"></i> Manage Students
    </div>                

    <div class="nav-link" onclick="showSection('settings', 'Settings')">
        <i class="fas fa-cog me-3"></i> Settings
    </div>                

    <div class="nav-link" onclick="logout()">
        <i class="fas fa-sign-out-alt me-3"></i> Logout
    </div>                
</div>


        

    
    <div class="content-area" id="main-content" onclick="hideSidebarOnCenterClick()">
        <div id="announcements" class="section-panel active-panel">
            <div class="card p-4 text-center">
                <i class="fas fa-bullhorn fa-3x text-primary mb-3"></i>
                <h5 class="fw-bold">Welcome back!</h5>
                <p class="text-muted small">Access your class materials and fee records securely. Try swiping from the left edge!</p>
            </div>
        </div>
        
        <div id="settings" class="section-panel">
            <h3 class="fw-bold mb-4">‚öôÔ∏è Settings</h3>
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Enable Notifications</span>
                    <input type="checkbox" id="notif-toggle" checked>
                </div>
                <hr>
                <button class="btn btn-danger w-100" onclick="clearAppData()">Clear App Cache</button>
                <p class="small text-muted mt-2">Removes locally cached data.</p>
            </div>
        </div>

        <div id="admin-teachers" class="section-panel">
    <h3 class="fw-bold mb-4">üè´ Admin Panel</h3>
    
    <div class="card p-3 mb-4">
        <h6>Create New Class</h6>
        <div class="row g-2">
            <div class="col-8"><input type="text" id="new-class-name" class="form-control" placeholder="Class Name (e.g. 10A)"></div>
            <div class="col-4"><button class="btn btn-success w-100" onclick="createClass()">Add</button></div>
        </div>
    </div>

    <div class="card p-3 mb-4">
        <h6>Bulk Student Transfer</h6>
        <div class="row g-2">
            <div class="col-5"><input type="text" id="transfer-from" class="form-control" placeholder="From Class"></div>
            <div class="col-5"><input type="text" id="transfer-to" class="form-control" placeholder="To Class"></div>
            <div class="col-2"><button class="btn btn-warning w-100" onclick="transferStudents()">Transfer</button></div>
        </div>
    </div>
    <div class="card p-3 mb-4">
        <h6>Add/Update Teacher</h6>
        <div class="row g-2">
            <div class="col-6"><input type="text" id="t-name" class="form-control" placeholder="Full Name"></div>
            <div class="col-6"><input type="text" id="t-id" class="form-control" placeholder="Teacher ID"></div>
            <div class="col-6"><input type="password" id="t-pass" class="form-control" placeholder="Password"></div>
            <div class="col-6"><input type="text" id="t-class" class="form-control" placeholder="Class Teacher (e.g. 10A)"></div>
        </div>
        <button class="btn btn-primary mt-2 w-100" onclick="addOrUpdateTeacher(this)">Save Teacher</button>
    </div>
    
    <div id="teacher-list">Loading teachers...</div>

    <div id="class-management-list" class="mt-4">
        <h6>Manage Classes</h6>
        <div id="classes-list-container">Loading classes...</div>
    </div>
    </div>
        <div id="student-directory" class="section-panel">
    <h3 class="fw-bold mb-4">üìñ Student Directory</h3>
    <div id="student-directory-container">Loading student data...</div>
    </div>

        <div id="staff-students" class="section-panel">
            <h3 class="fw-bold mb-4">üéì Manage Students</h3>
            <div class="card p-3 mb-4">
                <h6>Add New Student</h6>
                <div class="row g-2">
                    <div class="col-6"><input type="text" id="s-name" class="form-control" placeholder="Full Name"></div>
                    <div class="col-6"><input type="text" id="s-id" class="form-control" placeholder="Student ID"></div>
                    <div class="col-6"><input type="password" id="s-pass" class="form-control" placeholder="Password"></div>
                    <div class="col-6"><input type="text" id="s-class" class="form-control" placeholder="Class (e.g. 10A)"></div>
                    <div class="col-12"><input type="number" id="s-fees" class="form-control" placeholder="Total Fees"></div>
                </div>
                <button class="btn btn-primary mt-2 w-100" onclick="addOrUpdateStudent(this)">Save Student</button>
            </div>
            <div class="card p-3 mb-4">
                <h6>Manage Existing Students</h6>
                <input type="text" id="search-class" class="form-control mb-2" placeholder="Enter Class (e.g. 10A)" onkeyup="loadClassStudents()">
                <div id="student-list-mgmt"></div>
            </div>
        </div>

        <div id="attendance" class="section-panel">
            <h3 class="fw-bold mb-4">üìä Attendance</h3>
            <div id="teacher-attendance-controls" class="card p-3 mb-4" style="display:none;">
                <div class="row g-2">
                <div class="col-6">
                <select id="att-class-select" class="form-select" onchange="loadClassAttendance()">
                <option value="">Select Class</option>
            </select>
            </div>
            <div class="col-6"><input type="date" id="att-date-select" class="form-control" onchange="loadClassAttendance()"></div>
        </div>
            <div id="class-student-list" class="mt-3"></div>
    </div>
            <div id="student-attendance-view" style="display:none;">
                <div class="card p-3 text-center">
                <h5>Overall Attendance</h5>
            <div class="progress" style="height: 25px;">
                <div id="att-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" >0%</div>
            </div>
            <small id="att-stats" class="text-muted"></small>
        </div>
        <div id="student-attendance-list"></div>
    </div>
</div>

        <div id="fees" class="section-panel">
            <h3 class="fw-bold mb-4">üí≥ Fees</h3>
            <div id="fee-admin-controls" class="card p-3 mb-4" style="display:none;">
                <h6>Update Student Fees</h6>
                <div class="row g-2">
                    <div class="col-6"><input type="text" id="fee-sid" class="form-control" placeholder="Student ID"></div>
                    <div class="col-6"><input type="number" id="fee-paid" class="form-control" placeholder="Amount Paid"></div>
                </div>
                <button class="btn btn-primary mt-2" onclick="submitFeeUpdate(this)">Update Fee Record</button>
            </div>
            <div id="fee-content">Loading fee details...</div>
        </div>

        <div id="study-material" class="section-panel">
            <h3 class="fw-bold mb-4">üìö Materials</h3>
            <div id="material-upload-form" class="card p-3 mb-4" style="display:none;">
                <h6>Post New Material</h6>
                <div class="row g-2">
                    <div class="col-6"><input type="text" id="mat-title" class="form-control" placeholder="Title"></div>
                    <div class="col-6"><input type="text" id="mat-class" class="form-control" placeholder="Class (e.g. 10A)"></div>
                    <div class="col-12"><input type="url" id="mat-link" class="form-control" placeholder="URL Link"></div>
                </div>
                <button class="btn btn-success mt-2 w-100" onclick="uploadMaterial(this)">Upload Material</button>
            </div>
            <div id="material-list">Loading materials...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="showSection('announcements', 'Home')">
            <i class="fas fa-home"></i>Home
        </div>
        <div class="nav-item role-admin-teacher" id="nav-manage" style="display:none;" onclick="showSection('staff-students', 'Manage')">
            <i class="fas fa-users-cog"></i>Manage
        </div>
        <div class="nav-item" id="nav-att" onclick="showSection('attendance', 'Attendance')">
            <i class="fas fa-user-check"></i>Attendance
        </div>
        <div class="nav-item" id="nav-fees" onclick="showSection('fees', 'Fees')">
            <i class="fas fa-credit-card"></i>Fees
        </div>
        <div class="nav-item" id="nav-mat" onclick="showSection('study-material', 'Materials')">
            <i class="fas fa-book"></i>Materials
        </div>
    </div>
</div>

<script>
    // --- App Logic ---
let touchStartX = 0; 
let touchEndX = 0;

window.onload = function() {
    // Hide splash screen immediately if it exists
    const splash = document.getElementById('splash-screen');                
    if (splash) splash.style.display = 'none';

    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            const user = JSON.parse(savedUser);
            activateApp(user);
        } catch (e) {
            console.error("Storage parsing error", e);                
            document.getElementById('login-page').style.display = 'flex';
        }
    } else {
        document.getElementById('login-page').style.display = 'flex';
    }
};

// --- SIDEBAR & GESTURES ---
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuIcon = document.getElementById('menuIcon');

    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
    
    if (sidebar.classList.contains('active')) {
        menuIcon.classList.replace('fa-bars', 'fa-times');
    } else {
        menuIcon.classList.replace('fa-times', 'fa-bars');
    }
}

function hideSidebarOnCenterClick() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('active')) toggleSidebar();
}

// Swipe detection
document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
document.addEventListener('touchend', e => { 
    touchEndX = e.changedTouches[0].screenX;
    if (touchEndX - touchStartX > 100 && touchStartX < 50) toggleSidebar(); // Swipe Right
    if (touchStartX - touchEndX > 100 && document.getElementById('sidebar').classList.contains('active')) toggleSidebar(); // Swipe Left
}, {passive: true});

// --- AUTHENTICATION ---
async function handleLogin() {
    const id = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const btn = document.getElementById('loginBtn');
    if(!id || !password) return alert("Please fill all fields");

    btn.innerText = "Authenticating..."; btn.disabled = true;

    try {
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, password })
        });
        const result = await res.json();
        if (result.success) {
            localStorage.setItem('currentUser', JSON.stringify(result.user));
            activateApp(result.user);
        } else {
            alert("Login Failed: " + result.message);
        }
    } catch (e) { alert("Server Error"); }
    btn.innerText = "LOGIN"; btn.disabled = false;
}

function activateApp(user) {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';

    document.getElementById('user-display-name').innerText = user.name;
    document.getElementById('user-display-role').innerText = user.role.toUpperCase();
    document.getElementById('user-display-class').innerText = user.classId || 'N/A';
    document.getElementById('user-display-id').innerText = user.id;
     
    setupNav(user.role);
    loadDashboardBasedOnRole(user.role);

    const savedPhoto = localStorage.getItem('userPhoto');
    if (savedPhoto) document.getElementById('user-avatar').innerHTML = `<img src="${savedPhoto}" style="width:100%;height:100%;object-fit:cover;">`;
}

function logout() {
    localStorage.removeItem('currentUser');
    location.reload();
}

// --- NAVIGATION LOGIC ---
function setupNav(role) {
    // 1. Sidebar Role Filtering
    const navLinks = document.querySelectorAll('#nav-menu [data-role]');
    navLinks.forEach(link => {
        const allowedRoles = link.getAttribute('data-role').split(',');
        link.style.display = allowedRoles.includes(role) ? 'flex' : 'none';
    });

    // 2. Bottom Nav "Manage" Button visibility
    const bottomManage = document.getElementById('nav-manage');
    if (role === 'admin' || role === 'teacher') {
        bottomManage.style.display = 'block';
    }
}

function loadDashboardBasedOnRole(role) {
    if(role === 'admin') showSection('admin-teachers', 'Admin Panel');
    else if(role === 'teacher') showSection('staff-students', 'Manage Students');
    else showSection('announcements', 'Home');
}

function showSection(id, title) {
    document.querySelectorAll('.section-panel').forEach(p => p.classList.remove('active-panel'));
    const panel = document.getElementById(id);
    if(panel) panel.classList.add('active-panel');
    document.getElementById('header-title').innerText = title;
    
    // Update bottom nav active state
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    // (Optional: Match ID to nav-item to highlight the correct icon)

    if (id === 'attendance') { loadClassDropdown(); loadAttendanceSection(); }
    if (id === 'admin-teachers') { loadTeachers(); loadClassesForManagement(); }
    if (id === 'student-directory') loadStudentDirectoryClasswise();
    if (id === 'fees') loadFees();
    if (id === 'study-material') loadMaterials();
    if (id === 'staff-students') loadClassStudents();
    
    const sidebar = document.getElementById('sidebar');
    if(sidebar.classList.contains('active')) toggleSidebar();
}

// --- DATA LOADING & API CALLS ---
// (Your existing functions like loadTeachers, loadClassStudents, etc. are correct)
// Just ensure they are included below this line...
    
 


    // --- Profile Editing Logic (All Roles) ---
    function editName() {
    const nameElement = document.getElementById('user-display-name');
    const currentName = nameElement.innerText;
    const newName = prompt("Enter new name:", currentName);
    
    if (newName && newName !== currentName) {
        // Update UI immediately
        nameElement.innerText = newName;
        
        // Update LocalStorage to persist across sessions
        let user = JSON.parse(localStorage.getItem('currentUser'));
        if (user) {
            user.name = newName;
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // Call API to persist on server
            fetch('/api/user/update-name', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: user.id, name: newName})
            }).catch(err => console.error("API Error updating name", err));
        }
    }
}
    function updateProfilePhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const base64Image = e.target.result;
            
            // Update UI by replacing the icon with the image
            const avatarContainer = document.getElementById('user-avatar');
            avatarContainer.innerHTML = `<img src="${base64Image}" style="width: 100%; height: 100%; object-fit: cover;">`;
            
            // Save to LocalStorage (as Base64 string)
            localStorage.setItem('userPhoto', base64Image);
            
            // Call API to persist image to server (requires backend support)
            // fetch('/api/user/update-photo', { method: 'POST', body: ... });
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

    
    // --- Role-Based Data Loading ---
    async function loadMaterials() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        const list = document.getElementById('material-list');
        list.innerHTML = "Fetching...";
        
        try {
            const res = await fetch(`/api/materials/${user.classId}`);
            const data = await res.json();
            list.innerHTML = data.map(m => `
                <div class="card p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 fw-bold">${m.title}</h6>
                            <small class="text-muted">${new Date(m.date).toLocaleDateString()}</small>
                        </div>
                        <a href="${m.link}" target="_blank" class="button small">Open</a>
                    </div>
                </div>`).join('') || "No materials found.";
        } catch (e) { list.innerHTML = "Error."; }
    }

    async function uploadMaterial(btn) {
        const data = {
            title: document.getElementById('mat-title').value,
            link: document.getElementById('mat-link').value,
            classId: document.getElementById('mat-class').value
        };
        btn.disabled = true;
        const res = await fetch('/api/materials', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if ((await res.json()).success) { alert("Material Added!"); btn.disabled = false; loadMaterials(); }
    }

    async function submitFeeUpdate(btn) {
        const data = { studentId: document.getElementById('fee-sid').value, amountPaid: parseFloat(document.getElementById('fee-paid').value) };
        btn.disabled = true;
        const res = await fetch('/api/fees/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if ((await res.json()).success) { alert("Fee Updated!"); btn.disabled = false; }
    }

    async function loadFees() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        const content = document.getElementById('fee-content');
        
        if (user.role === 'admin' || user.role === 'teacher') {
            document.getElementById('fee-admin-controls').style.display = 'block';
        }

        try {
            const res = await fetch(`/api/student/profile/${user.id}`);
            const data = await res.json();
            if (data) {
                const remaining = data.totalFees - data.feesPaid;
                content.innerHTML = `
                    <div class="card bg-primary text-white p-4 text-center mb-3">
                        <small>REMAINING BALANCE</small>
                        <h1 class="fw-bold">‚Çπ${remaining}</h1>
                        <span class="badge bg-white text-primary">Status: ${remaining > 0 ? 'Pending' : 'Paid'}</span>
                    </div>
                    <div class="card p-3">
                        <div class="d-flex justify-content-between"><span>Total:</span><strong>‚Çπ${data.totalFees}</strong></div>
                        <div class="d-flex justify-content-between"><span>Paid:</span><strong class="text-success">‚Çπ${data.feesPaid}</strong></div>
                    </div>`;
            }
        } catch (e) { content.innerHTML = "Error loading fees."; }
    }

    document.getElementById('att-date-select').valueAsDate = new Date();

    async function loadAttendanceSection() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (user.role === 'admin' || user.role === 'teacher') {
            document.getElementById('teacher-attendance-controls').style.display = 'block';
            document.getElementById('student-attendance-view').style.display = 'none';
        } else {
            document.getElementById('teacher-attendance-controls').style.display = 'none';
            document.getElementById('student-attendance-view').style.display = 'block';
            loadStudentAttendanceView(user.id);
        }
    }

    async function loadClassAttendance() {
        const classId = document.getElementById('att-class-select').value;
        const date = document.getElementById('att-date-select').value;
        if (!classId || !date) return;
        const listContainer = document.getElementById('class-student-list');
        listContainer.innerHTML = "Loading...";
        const studentsRes = await fetch(`/api/students/class/${classId}`);
        const students = await studentsRes.json();
        const attRes = await fetch(`/api/attendance/${classId}/${date}`);
        const existingAtt = await attRes.json();
        const attMap = {};
        existingAtt.forEach(a => attMap[a.studentId] = a.status);
        listContainer.innerHTML = students.map(s => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                <span>${s.name}</span>
                <div>
                    <button class="btn btn-sm ${attMap[s.studentId] === 'Present' ? 'btn-success' : 'btn-outline-success'}" onclick="markAttendance('${s.studentId}', 'Present')">P</button>
                    <button class="btn btn-sm ${attMap[s.studentId] === 'Absent' ? 'btn-danger' : 'btn-outline-danger'}" onclick="markAttendance('${s.studentId}', 'Absent')">A</button>
                </div>
            </div>
        `).join('');
    }
    // --- NEW FUNCTIONS FOR CLASSES ---

async function loadClassesForManagement() {
    const container = document.getElementById('classes-list-container');
    container.innerHTML = "Loading...";

    try {
        const res = await fetch('/api/classes');
        const classes = await res.json();
        
        if (classes.length === 0) {
            container.innerHTML = "No classes found.";
            return;
        }

        container.innerHTML = classes.map(c => `
            <div class="card p-2 mb-2 d-flex justify-content-between align-items-center">
                <span><strong>${c.className}</strong></span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteClass('${c.className}')">Delete</button>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = "Error loading classes.";
    }
}

async function deleteClass(className) {
    if (!confirm(`Are you sure you want to delete ${className}?`)) return;

    const res = await fetch(`/api/admin/classes/delete/${className}`, {
        method: 'DELETE'
    });
    
    const result = await res.json();
    alert(result.message);
    if (result.success) {
        loadClassesForManagement(); // Refresh the list
    }
}

async function transferStudents() {
    const fromClass = document.getElementById('transfer-from').value.trim();
    const toClass = document.getElementById('transfer-to').value.trim();
    
    if (!fromClass || !toClass) return alert("Enter both classes");
    if (!confirm(`Move all students from ${fromClass} to ${toClass}?`)) return;

    const res = await fetch('/api/admin/transfer-class', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ fromClass, toClass })
    });
    
    const result = await res.json();
    alert(result.message);
}

// --- NEW FUNCTION FOR STUDENT DIRECTORY (ROLE-BASED) ---

    async function loadStudentDirectoryClasswise() {
        const container = document.getElementById('student-directory-container');
        const user = JSON.parse(localStorage.getItem('currentUser'));
        container.innerHTML = "Loading...";

    try {
        // --- SECURITY LOGIC ---
        // We pass user info to the backend to filter
        const res = await fetch('/api/teacher/students/list', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ role: user.role, classId: user.classId })
        });
        const students = await res.json();
        
        if (students.length === 0) {
            container.innerHTML = "No students found.";
            return;
        }

        // Grouping data by class for display
        const grouped = students.reduce((acc, student) => {
            const cls = student.classId || "Unassigned";
            if (!acc[cls]) acc[cls] = [];
            acc[cls].push(student);
            return acc;
        }, {});

        container.innerHTML = Object.keys(grouped).sort().map(className => `
            <div class="card p-3 mb-3">
                <h5 class="fw-bold text-primary mb-3">Class: ${className}</h5>
                ${grouped[className].map(s => `
                    <div class="d-flex justify-content-between border-bottom py-1">
                        <span>${s.name}</span>
                        <small class="text-muted">ID: ${s.studentId}</small>
                    </div>
                `).join('')}
            </div>
        `).join('');

    } catch (e) {
        container.innerHTML = "Error loading directory.";
        console.error(e);
    }
    }

    async function markAttendance(studentId, status) {
        const date = document.getElementById('att-date-select').value;
        const classId = document.getElementById('att-class-select').value;

    await fetch('/api/attendance/update', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({ studentId, date, status, classId }) 
    });

    loadClassAttendance(); // Now it refreshes with the new data
}


    async function loadStudentAttendanceView(studentId) {
        const res = await fetch(`/api/student/attendance/${studentId}`);
        const records = await res.json();
        const listContainer = document.getElementById('student-attendance-list');
        const progressBar = document.getElementById('att-progress-bar');
        let presentDays = records.filter(r => r.status === 'Present').length;
        let totalDays = records.length;
        let percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(1) : 0;
        progressBar.style.width = percentage + "%";
        progressBar.innerText = percentage + "%";
        progressBar.className = percentage >= 75 ? "progress-bar bg-success" : "progress-bar bg-danger";
        document.getElementById('att-stats').innerText = `${presentDays} Present / ${totalDays} Total Days`;
        listContainer.innerHTML = records.map(r => `
            <div class="card p-2 mb-1 d-flex justify-content-between">
                <span>${r.date}</span>
                <span class="badge ${r.status === 'Present' ? 'bg-success' : 'bg-danger'}">${r.status}</span>
            </div>
        `).join('') || "No records.";
    }
    // --- Updated Management Functions ---

async function addOrUpdateTeacher(btn) {
    const data = {
        name: document.getElementById('t-name').value,
        id: document.getElementById('t-id').value, 
        password: document.getElementById('t-pass').value,
        classId: document.getElementById('t-class').value
    };
    
    // Validation
    if(!data.id || !data.name) { 
        alert("Teacher ID and Name are required"); 
        return; 
    }
    
    btn.disabled = true;
    btn.innerText = "Saving...";

    try {
        // --- REAL API CALL ---
        const res = await fetch('/api/admin/teachers/upsert', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
            alert(result.message); // Will say "Created" or "Updated"
            loadTeachers(); // Refresh the list
        } else {
            alert("Error: " + result.message);
        }
    } catch (error) {
        alert("API Connection Error. Please try again.");
        console.error(error);
    } finally {
        btn.disabled = false;
        btn.innerText = "Save Teacher";
    }
}
    async function loadTeachers() {
    const list = document.getElementById('teacher-list');
    list.innerHTML = "Fetching...";
    
    try {
        // --- REAL API CALL ---
        const res = await fetch('/api/teachers');
        const data = await res.json();
        
        if (data.length > 0) {
            list.innerHTML = data.map(t => `
                <div class="card p-2 mb-2 d-flex justify-content-between align-items-center">
                    <span><strong>${t.name}</strong> (${t.id}) - Class: ${t.classId}</span>
                </div>
            `).join('');
        } else {
            list.innerHTML = `<div class="card p-2 text-center">No teachers found.</div>`;
        }
    } catch (error) {
        list.innerHTML = `<div class="card p-2 text-center text-danger">Error loading teachers.</div>`;
        console.error(error);
    }
}
    async function addOrUpdateStudent(btn) {
    const data = {
        name: document.getElementById('s-name').value,
        id: document.getElementById('s-id').value, 
        password: document.getElementById('s-pass').value,
        classId: document.getElementById('s-class').value,
        totalFees: parseFloat(document.getElementById('s-fees').value) || 0
    };
    
    // Validation
    if(!data.id || !data.name) { 
        alert("Student ID and Name are required"); 
        return; 
    }

    btn.disabled = true;
    btn.innerText = "Saving...";

    try {
        // --- REAL API CALL ---
        const res = await fetch('/api/teacher/students/upsert', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (result.success) {
            alert(result.message); // Will say "Created" or "Updated"
            loadClassStudents(); // Refresh the list
        } else {
            alert("Error: " + result.message);
        }
    } catch (error) {
        // --- ERROR DISPLAY ---
        alert("API Connection Error: " + error.message);
        console.error(error);
        // ------------------------------
    } finally {
        btn.disabled = false;
        btn.innerText = "Save Student";
    }
}

    async function loadClassStudents() {
        const classId = document.getElementById('search-class').value;
        const list = document.getElementById('student-list-mgmt');
        if(!classId) { list.innerHTML = "Enter a class to search."; return; }
        list.innerHTML = "Loading...";
        const res = await fetch(`/api/students/class/${classId}`);
        const data = await res.json();
        list.innerHTML = data.map(s => `
            <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                <span>${s.name} (${s.studentId})</span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${s.studentId}')">Delete</button>
            </div>
        `).join('') || "No students found.";
    }

    async function deleteStudent(id) {
        if(!confirm("Are you sure?")) return;
        await fetch(`/api/teacher/students/${id}`, { method: 'DELETE' });
        loadClassStudents();
    }

    // --- ADD TO SCRIPT TAG ---

// Function to create a new class
async function createClass() {
    const className = document.getElementById('new-class-name').value.trim();
    if (!className) return alert("Enter class name");

    const res = await fetch('/api/admin/classes/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ className })
    });
    
    const result = await res.json();
    alert(result.message);
    if (result.success) {
        document.getElementById('new-class-name').value = '';
        loadClassDropdown(); // Refresh dropdown
    }
}

// Function to load classes into the attendance dropdown
async function loadClassDropdown() {
    const select = document.getElementById('att-class-select');
    const res = await fetch('/api/classes');
    const classes = await res.json();
    
    // Keep the first option
    select.innerHTML = '<option value="">Select Class</option>';
    
    classes.forEach(c => {
        const option = document.createElement('option');
        option.value = c.className;
        option.innerText = c.className;
        select.appendChild(option);
    });
}

// --- CALL THIS FUNCTION WHEN ATTENDANCE SECTION LOADS ---
// Inside showSection function, add:
// if (id === 'attendance') { loadClassDropdown(); loadAttendanceSection(); }

    // --- SETTINGS LOGIC ---
    function clearAppData() {
        if (confirm("Are you sure? This will clear local cached data.")) {
            // Simulated cache clearing
            alert("Cache Cleared!");
        }
    }
</script>
</body>
</html>
